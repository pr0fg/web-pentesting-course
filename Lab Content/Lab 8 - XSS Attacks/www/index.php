<?php

include 'header.php';
include 'db.php';

$errorMsg = '';

if(!empty($_REQUEST) && isset($_REQUEST['title']) && isset($_REQUEST['content']) && !empty($_REQUEST['title']) && !empty($_REQUEST['content'])) {

    $content = strtolower($_REQUEST['content']);
    if(strpos($content, 'script') == false && strpos($content, 'img') == false) {

        $stmt = $dbh->prepare("INSERT INTO posts (user_id, title, content) VALUES(?, ?, ?)");
        $result = $stmt->execute(array($_SESSION['id'], $_REQUEST['title'], nl2br($content)));

        if($result) {
            $errorMsg = 'Post successfully added!';
        }
        else {
            $errorMsg = 'Invalid post content or length!';
        }
    }
    else {
        $errorMsg = 'Invalid post content or length!';
    }
}

?>

<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8" />
  <title>Forum Home</title>
</head>
<body>
    <h1 id="name">Welcome back <i><?= $_SESSION['username'] ?></i></h1>
    <input type="button" onclick="window.location.href = '/messages.php';" value="Messages"/>
    <input type="button" onclick="window.location.href = '/logout.php';" value="Logout"/>
    <input type="button" onclick="window.location.href = '/reset.php';" value="Reset Application"/>
    <br/><br/>
    <div class="error"><font color="red"><?= $errorMsg ?></font></div>
    <h2>Recent Posts:</h2>
    <div id="posts" style="width: 80%">
        <table>
            <tr><th align="left" style="padding-right:50px;">User</th><th align="left" style="padding-right:50px;">Post Title</th><th align="left">Link</th></tr>

            <?php

                $stmt = $dbh->prepare("SELECT users.username, posts.title, posts.id FROM posts JOIN users ON posts.user_id=users.id ORDER BY posts.id ASC LIMIT 10;");
                $stmt->execute();
                $posts = $stmt->fetchAll();
                foreach ($posts as $post) {
                    echo '<tr><td style="padding-right:50px;">';
                    echo $post['username'];
                    echo '</td><td style="padding-right:50px;">';
                    echo $post['title'];
                    echo '</td><td style="padding-right:50px;"><a href="/viewPost.php?i='. $post['id'] . '">View Post</a></td></tr>';
                }
        
            ?>

        </table>
    </div>
    <br/>
    <h2>Create Post:</h2>
    <form name="input" action="" method="post">
        Title: <input type="text" size="50" value="" id="title" name="title" /><br/>
        Content:<br/>
        <textarea name="content" rows="10" cols="100"></textarea><br/>
        <input type="submit" value="Post" name="post" />
    </form>
    <br/>
</body>
</html>