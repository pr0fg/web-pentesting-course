<?php

session_start();
if (isset($_SESSION['username'])) {
  header("Location: /");
  die();
}

$errorMsg = '';

if(!empty($_REQUEST) && isset($_REQUEST['username']) && isset($_REQUEST['password'])) {

  include 'db.php';

  $stmt = $dbh->prepare("SELECT * FROM users WHERE username=? AND password=? LIMIT 1");

  if ($stmt->execute(array($_REQUEST['username'], $_REQUEST['password']))) {
    if($row = $stmt->fetch()) {
      $_SESSION['username'] = $row['username'];
      $_SESSION['id'] = $row['id'];
      header("Location: /");
      die();
    }
    else {
      $errorMsg = 'Invalid username or password';
    }
  }
}

?>
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8" />
  <title>Login</title>
</head>
<body>
  <form name="input" action="" method="post">
    <label for="username">Username:</label><input type="text" value="" id="username" name="username" /><br/>
    <label for="password">Password:</label><input type="password" value="" id="password" name="password" /><br/>
    <input id="submit" type="submit" value="Login" name="login" />
  </form>
  <div class="error"><font color="red"><?= $errorMsg ?>
  <script>
    var url = unescape(document.location);
    if(url.indexOf('error=') > 0) {
      var error = url.substring(url.indexOf('error=') + 6, url.length);
      document.write('Error: ' + error);
    }
  </script>
  </font></div>
</body>
</html>