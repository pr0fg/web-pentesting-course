<?php

include 'header.php';
include 'db.php';

$errorMsg = '';

if(!empty($_REQUEST) && isset($_REQUEST['message']) && !empty($_REQUEST['message'])) {

    $filtered_message = strtolower($_REQUEST['message']);
    $filtered_message = str_replace('script', '', $filtered_message);
    $filtered_message = str_replace('onerror', '', $filtered_message);
    $filtered_message = str_replace('onload', '', $filtered_message);

    $stmt = $dbh->prepare("INSERT INTO messages (from_id, to_id, message) VALUES(?, ?, ?)");
    $result = $stmt->execute(array($_SESSION['id'], $_REQUEST['user_id'], $filtered_message));
    if($result) {
        $errorMsg = 'Message sent!';
    }
    else {
        $errorMsg = 'Invalid message content or length!';
    }
}

?>

<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8" />
  <title>Forum Messages</title>
</head>
<body>
    <div class="error"><font color="red"><?= $errorMsg ?></font></div>
    <h2>Inbox:</h2>
    <div id="messages" style="width: 80%">
        <table>
            <tr><th align="left" style="padding-right:50px;">From</th><th align="left">Message</th></tr>

            <?php

                $stmt = $dbh->prepare("SELECT messages.id, users.username, messages.message FROM messages JOIN users ON messages.from_id=users.id WHERE messages.to_id=? ORDER BY messages.id ASC");
                $stmt->execute(array($_SESSION['id']));

                $messages = $stmt->fetchAll();
                foreach ($messages as $message) {
                    echo '<tr><td style="padding-right:50px;">';
                    echo $message['username'];
                    echo '</td><td>'; 
                    echo $message['message'];
                    echo '</td></tr>';
                }
        
            ?>

        </table>
    </div>
    <br/>
    <h2>Sent Messages:</h2>
    <div id="sent_messages" style="width: 80%">
        <table>
            <tr><th align="left" style="padding-right:50px;">To</th><th align="left">Message</th></tr>

            <?php

                $stmt = $dbh->prepare("SELECT messages.id, users.username, messages.message FROM messages JOIN users ON messages.to_id=users.id WHERE messages.from_id=? ORDER BY messages.id ASC");
                $stmt->execute(array($_SESSION['id']));

                $messages = $stmt->fetchAll();
                foreach ($messages as $message) {
                    echo '<tr><td style="padding-right:50px;">';
                    echo $message['username'];
                    echo '</td><td>';
                    echo $message['message'];
                    echo '</td></tr>';
                }
        
            ?>

        </table>
    </div>
    <br/>
    <h2>Send Message:</h2>
    <form name="input" action="" method="post">
        To: <select id="user_id" name="user_id">
            <?php
                $stmt = $dbh->prepare("SELECT id, username FROM users");
                $stmt->execute();
                $users = $stmt->fetchAll();
                foreach ($users as $user) {
                    echo '<option value="' . $user['id'] . '">' . $user['username'] . '</option>';
                }
            ?>
        </select><br/>
        Message:<br/><textarea name="message" rows="5" cols="75"></textarea><br/>
        <input type="submit" value="Send" name="send" />
    </form>
    <br/><br/>
    <input type="button" onclick="window.location.href = '/';" value="Back"/>
</body>
</html>