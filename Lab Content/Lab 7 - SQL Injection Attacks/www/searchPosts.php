<?php

include 'header.php';

?>

<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8" />
  <title>Search Results</title>
</head>
<body>
    <h2>Search Results:</h2>
    <table>
        <tr><th>Post Title</th><th>View</th></tr>

        <?php

            if(!empty($_REQUEST) && isset($_REQUEST['q']) && !empty($_REQUEST['q'])) {

                include 'db.php';

                $query = strtolower($_REQUEST['q']);

                $result = $mysqli->query("SELECT title,id FROM posts WHERE title LIKE '%$query%' AND visible=1");

                if(!$result) {
                    die("MySQL query failed: (" . $mysqli->errno . ") " . $mysqli->error);
                }

                while($post = $result->fetch_assoc()) {
                    echo '<tr><td>' . $post['title'] . '</td><td><a href="/viewPost.php?i=' . $post['id'] . '">View Post</a></td></tr>';

                    if(strpos(strtolower($post['title']), '5.7.28') !== false) {
                        echo 'Challenge 3 complete! Flag: 3e40f30d9e30dff7f1b20f8bee7d5c8c';
                    }
                }

            }

        ?>
    </table>
    <br/>
    <input type="button" onclick="window.location.href = '/';" value="Back"/>
</body>
</html>