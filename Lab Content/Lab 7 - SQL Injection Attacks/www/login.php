<?php

session_start();
if (isset($_SESSION['username'])) {
  header("Location: /index.php");
  die();
}

if(strpos(strtolower($_SERVER['HTTP_USER_AGENT']), 'sqlmap') !== false) {
  die();
}

$errorMsg = '';

if(!empty($_POST) && isset($_POST['username']) && isset($_POST['password'])) {

  $username = strtolower($_POST['username']);
  $password = md5(rtrim($_POST['password']));

  if(strpos($username, 'jane.doe') !== false && $username !== 'jane.doe') {
    $errorMsg = "Invalid username or password.";
  }

  else {

    include 'db.php';

    $result = $mysqli->query("SELECT * FROM users WHERE username='$username' AND password='$password'");
    if(!$result) {
        die("MySQL query failed: (" . $mysqli->errno . ") " . $mysqli->error);
    }

    if($result->num_rows == 1) {
      $row = $result->fetch_assoc();
      $_SESSION['username'] = $row['username'];
      $_SESSION['id'] = $row['id'];
      header("Location: /index.php");
    }
    else {
      $errorMsg = "Invalid username or password.";
    }
  }
}

?>
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8" />
  <title>Login</title>
</head>
<body>
  <form name="input" action="" method="post">
    <label for="username">Username:</label><input type="text" value="" id="username" name="username" /><br/>
    <label for="password">Password:</label><input type="password" value="" id="password" name="password" /><br/>
    <input type="submit" value="Login" name="login" />
  </form>
  <div class="error"><font color="red"><?= $errorMsg ?></font></div>
</body>
</html>