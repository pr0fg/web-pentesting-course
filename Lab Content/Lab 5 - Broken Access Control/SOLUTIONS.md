Lab 5 Solutions
======


### Challenge 1
An obscured JavaScript file loaded from /js/jquery.js fetches a logged-in user's details from the API endpoint `/api/user/detail.php`. When this JavaScript code is executed, it renders a hidden menu button if an admin is logged in. 

View the content of this JavaScript file to reveal the hidden admin directory at `/29f553b835f8`. Brute-force this directory with a list of common filenames to reveal the file at `/29f553b835f8/backup.php`. Don't forget to specify the correct file extension, `php`!


### Challenge 2
When inspecting the JavaScript code during Challenge 1, you should see a hidden link to `/29f553b835f8/admin.php`. Visiting this URL results in a blank page being rendered. 

Brute-force the hidden URL parameter used to authenticate yourself as an administrator. Load the page using the correct URL `/29f553b835f8/admin.php?admin=1` to retrieve the flag.


### Challenge 3
Once logged in, we should observe a XHR request being sent from `/index.php` to the API endpoint `/api/user/details.php?u=8171`. It should be apparent that the `u` parameter specifies the user's ID in the system. 

To find the Michael.Miller user, we can brute-force this API endpoint using a script. Be sure to include your cookie in the request!

```bash
for i in {8000..9000}; do 
	curl -s -b "PHPSESSID=q6blpjbq7278t9546mv9ikvkkm" "http://container-ip:8080/api/user/details.php?u=$i" | grep Michael | grep Miller
done
```


### Challenge 4
On the main page of this application, we see all of the user's current messages and an option to export these messages as a CSV. Clicking the `Export Messages` link brings us to a page located at `/export.php`, of which allows us to download our CSV file from a URL like `/downloads/1581777404-messages.csv`. 

Upon careful observation, you should realize the "random" ID prepended to the filename is actual an epoch value. Considering there may be other users on this system who have recently exported their messages, we should brute-force epoch values in the last few hours and attempt to guess valid filenames. If we guess a correct filename, we will be able to download the user's messages file.

To do so, first retrieve your cookie, then use a script such as:

```bash
for e in {1581772404..1581777404}; do
	m=$(curl -s -b "PHPSESSID=q6blpjbq7278t9546mv9ikvkkm" "http://container-ip:8080/downloads/$e-messages.csv")
	echo "$m" | grep "from" && echo "Found message file at http://container-ip:8080/downloads/$e-messages.csv"
done
```


### Challenge 5
When first accessing the web app after logging in, we should see a list of posts visible to the user. Clicking `View Post` brings us to a page that displays the post's title and full content. 

We should observe that the retrieval of the post's content is done using a XHR request to the `/api/posts/1.php` API endpoint. Presumably the number in the URL is the post's ID. 

To view all posts in the system, we can try to brute-force this API endpoint by iterating through possible post ID numbers. Keep in mind that the API checks to see if you're logged in and if the referer header is set to `http://container-ip/viewPost.php?i=[postID]`.

The following solution script can be used to discover hidden post #77:

```bash
for i in {1..100}; do
	r=$(curl -s -b "PHPSESSID=q6blpjbq7278t9546mv9ikvkkm" -H "Referer: http://container-ip:8080/viewPost.php?i=$i" "http://container-ip:8080/api/posts/$i.php")
	echo "$r" | grep -q '"id"' && echo "Found post #$i"
done
``` 

The discovered post, #77, can be retrieved by executing:

```bash
curl -s -b "PHPSESSID=q6blpjbq7278t9546mv9ikvkkm" -H "Referer: http://container-ip:8080/viewPost.php?i=77" "http://container-ip:8080/api/posts/77.php"
```


### Challenge 6
Throughout exploring this application, we should see many calls to API endpoints under `/api/user` and `/api/posts`. Ergo, perhaps `/api/admin` also exists. Use a tool like gobuster to brute-force common filenames (don't forget to add the .php extension) within this endpoint. This will reveal a hidden admin API endpoint at `/api/admin/manage.php`.


### Challenge 7
All previously discovered API endpoints under `/api` should be checked using cURL to determine if they are accessible when you're not logged in. After checking each URL manually, you should notice that the `/api/posts/released.php` API endpoint fails to check if you're logged in.

